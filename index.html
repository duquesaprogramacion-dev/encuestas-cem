<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Autosol | Encuesta CEM</title>
 <style>
  :root{
    --bg1:#070B14;
    --bg2:#0B1220;
    --card: rgba(255,255,255,.06);
    --card2: rgba(255,255,255,.03);
    --text:#EAF0FF;
    --muted:#A9B7D6;
    --border: rgba(255,255,255,.10);
    --brand:#2F7DFF;
    --brand2:#22C55E;
    --danger:#FF5A5F;
    --shadow: 0 18px 50px rgba(0,0,0,.45);
    --radius: 20px;
    --radius2: 16px;
    --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:var(--font);
    color:var(--text);
    min-height:100vh;
    background:
      radial-gradient(1000px 600px at 15% 15%, rgba(47,125,255,.25), transparent 60%),
      radial-gradient(900px 520px at 80% 25%, rgba(34,197,94,.14), transparent 55%),
      radial-gradient(700px 420px at 55% 95%, rgba(255,90,95,.10), transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
  }

  .wrap{max-width:980px;margin:0 auto;padding:28px 18px 110px}

  header{
    display:flex;align-items:center;gap:14px;
    margin-bottom:18px;
  }

  .logo{
    width:46px;height:46px;border-radius:14px;
    background:linear-gradient(135deg, rgba(47,125,255,.95), rgba(47,125,255,.35));
    border:1px solid rgba(255,255,255,.14);
    box-shadow: var(--shadow);
    display:grid;place-items:center;
    font-weight:900;
    letter-spacing:.5px;
  }

  .title h1{margin:0;font-size:18px;letter-spacing:.2px}
  .title p{margin:4px 0 0;color:var(--muted);font-size:13px}

  .card{
    background: linear-gradient(180deg, var(--card), var(--card2));
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
    backdrop-filter: blur(10px);
  }

  .body{padding:18px}

  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    background: rgba(0,0,0,.14);
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid var(--border);
    background: rgba(255,255,255,.04);
    font-size:12px;
    color:var(--muted);
  }

  .pill strong{color:var(--text);font-weight:800}

  .sectionTitle{
    margin: 14px 0 10px;
    font-size:14px;
    letter-spacing:.2px;
  }

  /* Preguntas */
  .q{
    background: rgba(10,18,35,.45);
    border: 1px solid var(--border);
    border-radius: var(--radius2);
    padding: 14px;
    margin: 12px 0;
    transform: translateY(6px);
    opacity: 0;
    animation: fadeUp .32s ease forwards;
  }

  @keyframes fadeUp{
    to{ transform: translateY(0); opacity:1; }
  }

  .q h3{
    margin:0 0 12px;
    font-size:14px;
    line-height:1.35;
    font-weight: 750;
  }

  /* Escala 1..5 moderna */
  .scale5{
    display:grid;
    grid-template-columns: repeat(5, 1fr);
    gap:10px;
  }

  .rateBtn{
    position:relative;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.04);
    padding: 12px 0;
    cursor:pointer;
    user-select:none;
    transition: transform .08s ease, border-color .18s ease, background .18s ease, box-shadow .18s ease;
    text-align:center;
    overflow:hidden;
  }

  .rateBtn:hover{ transform: translateY(-1px); }
  .rateBtn:active{ transform: translateY(0); }

  .rateBtn .n{
    font-weight:900;
    font-size:16px;
    letter-spacing:.3px;
  }

  .rateBtn .lab{
    display:block;
    margin-top:4px;
    font-size:11px;
    color:var(--muted);
  }

  .rateBtn.active{
    border-color: rgba(47,125,255,.85);
    background: rgba(47,125,255,.18);
    box-shadow: 0 0 0 3px rgba(47,125,255,.12) inset;
  }

  /* Barra de progreso por pregunta (visual â€œproâ€) */
  .bar{
    height:8px;
    border-radius:999px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.08);
    overflow:hidden;
    margin-top:12px;
  }
  .bar > div{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, rgba(255,90,95,.9), rgba(47,125,255,.9), rgba(34,197,94,.9));
    transition: width .25s ease;
  }

  .hint{
    display:flex;
    justify-content:space-between;
    font-size:12px;
    color:var(--muted);
    margin-top:10px;
  }

  /* Acciones */
  .actions{
    display:flex;
    gap:10px;
    justify-content:flex-end;
    padding: 14px 18px;
    border-top: 1px solid var(--border);
    background: rgba(0,0,0,.14);
  }

  .btn{
    border: 1px solid var(--border);
    background: rgba(255,255,255,.06);
    color: var(--text);
    padding: 10px 14px;
    border-radius: 14px;
    cursor:pointer;
    font-weight: 800;
    letter-spacing:.2px;
    transition: transform .08s ease, background .18s ease, border-color .18s ease;
  }
  .btn:hover{ transform: translateY(-1px); }
  .btn:active{ transform: translateY(0); }
  .btn.primary{
    background: rgba(47,125,255,.22);
    border-color: rgba(47,125,255,.65);
  }
  .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

  /* Toast */
  .toast{
    margin-top:12px;
    font-size:13px;
    color:var(--muted);
    min-height:18px;
  }
  .toast.ok{ color: rgba(34,197,94,.95); }
  .toast.err{ color: rgba(255,90,95,.95); }

  /* Chatbot flotante mÃ¡s vivo */
  @keyframes bob{
    0%{ transform: translateY(0); }
    50%{ transform: translateY(-8px); }
    100%{ transform: translateY(0); }
  }

  @keyframes pulseRing{
    0%{ box-shadow: 0 0 0 0 rgba(47,125,255,.25); }
    70%{ box-shadow: 0 0 0 14px rgba(47,125,255,0); }
    100%{ box-shadow: 0 0 0 0 rgba(47,125,255,0); }
  }

  .chatFab{
    position: fixed; right: 18px; bottom: 18px;
    width: 60px; height: 60px; border-radius: 20px;
    background: linear-gradient(135deg, rgba(47,125,255,.95), rgba(47,125,255,.35));
    border: 1px solid rgba(255,255,255,.20);
    box-shadow: var(--shadow);
    display:grid; place-items:center;
    cursor:pointer; z-index: 50;
    animation: bob 2.6s ease-in-out infinite, pulseRing 2.8s ease-out infinite;
    font-size: 20px;
  }

  .chatWin{
    position: fixed; right: 18px; bottom: 92px;
    width: min(380px, calc(100vw - 36px));
    border-radius: 18px; overflow:hidden;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    background: rgba(10,18,35,.92);
    backdrop-filter: blur(10px);
    z-index: 51;
    display:none;
    transform: translateY(10px);
    opacity: 0;
    transition: .18s ease;
  }
  .chatWin.show{ transform: translateY(0); opacity: 1; }

  .chatHeader{
    padding: 12px 14px; display:flex;
    align-items:center; justify-content:space-between;
    border-bottom: 1px solid var(--border);
    background: rgba(0,0,0,.18);
  }
  .chatHeader strong{ font-size: 13px; letter-spacing:.2px; }
  .chatHeader button{ border:none;background:transparent;color:var(--muted);cursor:pointer;font-size:16px; }

  .chatBody{
    padding: 12px; max-height: 340px; overflow:auto;
    display:flex; flex-direction:column; gap: 10px;
  }

  .bubble{
    padding: 10px 12px; border-radius: 14px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.04);
    font-size: 13px; line-height: 1.35;
  }
  .bubble.me{
    align-self:flex-end;
    background: rgba(47,125,255,.15);
    border-color: rgba(47,125,255,.35);
  }

  .quick{display:flex;flex-wrap:wrap;gap:8px;}
  .chip{
    border: 1px solid var(--border);
    background: rgba(255,255,255,.04);
    color: var(--text);
    padding: 8px 10px;
    border-radius: 999px;
    cursor:pointer;
    font-size: 12px;
    font-weight: 800;
    transition: transform .08s ease, background .18s ease;
  }
  .chip:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); }

   .grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 6px;
}
@media (max-width:760px){
  .grid{ grid-template-columns: 1fr; }
}

label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px;}
input, select, textarea{
  width:100%;
  border-radius: 14px;
  padding: 11px 12px;
  border: 1px solid var(--border);
  background: rgba(10,18,35,.55);
  color: var(--text);
  outline: none;
}
textarea{min-height:90px;resize:vertical;}

.section{
  margin: 14px 0 10px;
  font-size: 14px;
  letter-spacing: .2px;
}

</style>

</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">A</div>
      <div class="title">
        <h1>Autosol | Encuesta CEM</h1>
        <p>Tu opiniÃ³n nos ayuda a mejorar el servicio.</p>
      </div>
    </header>

    <div class="card">
       <div class="topbar">
    <div class="pill">Encuesta: <strong>Autosol CEM</strong></div>
    <div class="pill" id="progressPill">Progreso: <strong>0%</strong></div>
  </div>

      <div class="body">
        <div class="grid">
          <div><label>Nombre (opcional)</label><input id="nombre" /></div>
          <div><label>TelÃ©fono (opcional)</label><input id="telefono" /></div>
          <div><label>Chasis o VIN (opcional)</label><input id="vin" placeholder="Ej: 9BW..." /></div>
          <div><label>Sucursal (opcional)</label>
            <select id="sucursal"><option value="">Seleccionar</option><option>Jujuy</option><option>Salta</option><option>Tartagal</option></select>
          </div>
          <div><label>Asesor (opcional)</label><input id="asesor" /></div>
        </div>

        <div class="section">Preguntas</div>
        <div id="questions"></div>

        <div class="section">Comentario (opcional)</div>
        <textarea id="comentario"></textarea>

        <div class="toast" id="toast"></div>
      </div>

      <div class="actions">
        <button class="btn" id="btnReload" type="button">Recargar</button>
        <button class="btn primary" id="btnSend" type="button">Enviar encuesta</button>
      </div>
    </div>
  </div>

  <div class="chatFab" id="chatFab">ðŸ’¬</div>
  <div class="chatWin" id="chatWin">
    <div class="chatHeader">
      <strong>Ayuda Autosol</strong>
      <button id="chatClose" style="border:none;background:transparent;color:#a9b7d6;cursor:pointer;font-size:16px">âœ•</button>
    </div>
    <div class="chatBody" id="chatBody">
      <div class="bubble">Hola ðŸ‘‹ ElegÃ­ una opciÃ³n:</div>
      <div class="quick" id="quick"></div>
    </div>
  </div>

<script>
  const PROXY_URL = "https://cem-encuestas.nelson-calidad15.workers.dev";
  const API_TOKEN = "autosol12345678";
  const ENCUESTA  = "Encuesta CEM";

  let QUESTIONS = [];
  const ANSWERS = {};
  const $ = (id) => document.getElementById(id);
  const toast = (m)=> $("toast").textContent = m || "";
  const esc = (s)=> String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));

  async function loadQuestions(){
    toast("Cargando preguntas...");
    $("questions").innerHTML = "";
    Object.keys(ANSWERS).forEach(k => delete ANSWERS[k]);

    const url = `${PROXY_URL}?json=1&token=${encodeURIComponent(API_TOKEN)}&encuesta=${encodeURIComponent(ENCUESTA)}`;
    const res = await fetch(url);
    const data = await res.json();

    if(!data.ok){ toast("Error: " + (data.error || "No se pudo cargar")); return; }
    QUESTIONS = data.preguntas || [];
    renderQuestions();
    toast("");
  }

function renderQuestions(){
  const wrap = $("questions");
  wrap.innerHTML = "";

  QUESTIONS.forEach((q, idx) => {
    const div = document.createElement("div");
    div.className = "q";
    div.style.animationDelay = `${idx * 40}ms`;

    // escala 1..5
    const labels = ["Muy bajo","Bajo","Medio","Alto","Excelente"];

    div.innerHTML = `
      <h3>${esc(q.pregunta)}</h3>

      <div class="scale5" role="group" aria-label="Escala 1 a 5">
        ${Array.from({length:5},(_,k)=>{
          const v = k+1;
          return `
            <div class="rateBtn" data-qid="${esc(q.id)}" data-val="${v}">
              <div class="n">${v}</div>
              <span class="lab">${labels[k]}</span>
            </div>
          `;
        }).join("")}
      </div>

      <div class="bar" aria-hidden="true"><div id="bar_${esc(q.id)}"></div></div>
      <div class="hint"><span>1 = Muy bajo</span><span>5 = Excelente</span></div>
    `;

    wrap.appendChild(div);
  });

  wrap.querySelectorAll(".rateBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const qid = btn.getAttribute("data-qid");
      const val = Number(btn.getAttribute("data-val"));

      // activar solo uno por pregunta
      const group = btn.parentElement;
      group.querySelectorAll(".rateBtn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      ANSWERS[qid] = val;

      // barra visual
      const bar = document.getElementById(`bar_${qid}`);
      if (bar) bar.style.width = `${(val/5)*100}%`;

      updateProgress();
    });
  });

  updateProgress();
}



  function validate(){
    for(const q of QUESTIONS){
      if(!(q.id in ANSWERS)) return `Falta responder: "${q.pregunta}"`;
    }
    return null;
  }

  async function send(){
    const err = validate();
    if(err){ toast(err); return; }

    $("btnSend").disabled = true;
    toast("Enviando...");

    const payload = {
      token: API_TOKEN,
      encuesta: ENCUESTA,
      meta: {
        nombre: $("nombre").value.trim(),
        telefono: $("telefono").value.trim(),
        vin: $("vin").value.trim(),
        asesor: $("asesor").value.trim(),
        sucursal: $("sucursal").value,
        comentario: $("comentario").value.trim()
      },
      respuestas: QUESTIONS.map(q=>({
        id_pregunta: q.id,
        pregunta: q.pregunta,
        respuesta: ANSWERS[q.id]
      })),
      user_agent: navigator.userAgent
    };

    try{
      const res = await fetch(PROXY_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(!data.ok){ toast("Error: " + (data.error || "No se pudo guardar")); return; }
      toast("Â¡Gracias! Encuesta registrada.");
    } catch(e){
      toast("Error de red: " + e);
    } finally {
      $("btnSend").disabled = false;
    }
  }

  const FAQ = [
    { q:"Â¿Para quÃ© es esta encuesta?", a:"Es una encuesta CEM para mejorar la experiencia de compra en Autosol." },
    { q:"Â¿CuÃ¡nto tarda?", a:"Menos de 1 minuto. Escala 0 a 5." },
    { q:"Â¿Mis datos son obligatorios?", a:"No, son opcionales." }
  ];
  function addBubble(t, me){
    const d=document.createElement("div");
    d.className="bubble"+(me?" me":"");
    d.textContent=t;
    $("chatBody").appendChild(d);
    $("chatBody").scrollTop=$("chatBody").scrollHeight;
  }
  function initChat(){
    const quick=$("quick");
    FAQ.forEach(item=>{
      const b=document.createElement("button");
      b.className="chip"; b.type="button"; b.textContent=item.q;
      b.onclick=()=>{ addBubble(item.q,true); addBubble(item.a,false); };
      quick.appendChild(b);
    });
 $("chatFab").onclick = () => {
  const w = $("chatWin");
  if (w.style.display === "block") closeChat();
  else openChat();
};

$("chatClose").onclick = closeChat;

  }

  $("btnSend").onclick = send;
  $("btnReload").onclick = loadQuestions;
  initChat();
  loadQuestions();

  function openChat(){
  const w = document.getElementById("chatWin");
  w.style.display = "block";
  requestAnimationFrame(() => {
    w.classList.add("show");
  });
}

function closeChat(){
  const w = document.getElementById("chatWin");
  w.classList.remove("show");
  setTimeout(() => {
    w.style.display = "none";
  }, 180);
}




</script>
</body>
</html>
